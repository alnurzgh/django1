# Сервис бронирования жилья

Современная платформа для аренды жилья с функционалом бронирования, календарем доступности и интеграцией с внешними календарями.

## Технологии

- **Backend**: Django 6.0, Django REST Framework
- **База данных**: SQLite (для разработки)
- **Язык**: Python 3.14+

## Основные возможности

### ✅ Реализовано

1. **Расширенная модель объектов жилья**
   - Верификация объектов (статус "Проверено")
   - Детальные удобства (Wi-Fi, парковка и т.д.)
   - Координаты для карты
   - Правила дома
   - Гибкое ценообразование (будни/выходные, скидки за длительное проживание)
   - Типы бронирования (мгновенное / по запросу)

2. **Система бронирования**
   - Мгновенное бронирование (Instant Booking)
   - Бронирование с подтверждением владельца
   - Проверка доступности на выбранные даты
   - Защита от овербукинга

3. **Умный календарь (Availability)**
   - Хранение доступности по датам
   - Интеграция с внешними календарями через iCal
   - Автоматическая синхронизация занятых дат

4. **Система отзывов**
   - Только для реально проживавших (верифицированные отзывы)
   - Детальные оценки (чистота, коммуникация, расположение, цена/качество)

5. **Коммуникации**
   - Система сообщений между владельцами и гостями
   - Привязка к бронированиям

6. **API**
   - REST API на Django REST Framework
   - Поиск с фильтрами по датам, цене, типу, городу
   - Оптимизированные запросы для поиска по доступности

## Установка

### 1. Установите зависимости

```bash
pip install -r requirements.txt
```

### 2. Примените миграции

```bash
python manage.py makemigrations
python manage.py migrate
```

### 3. Создайте суперпользователя

```bash
python manage.py createsuperuser
```

### 4. Запустите сервер

```bash
python manage.py runserver
```

## Использование

### Создание объектов удобств (Amenity)

Сначала создайте удобства через админ-панель или через API:
- Wi-Fi
- Парковка
- Кондиционер
- Бассейн
- И т.д.

### Создание объекта жилья

1. Через админ-панелю: `/admin/listings/listing/add/`
2. Через API: `POST /api/listings/`

### Синхронизация iCal календарей

Для синхронизации с внешними календарями (например, Google Calendar):

1. Получите публичную ссылку на iCal календарь
2. Создайте запись ICalSync через API или админ-панель
3. Синхронизируйте вручную через API: `POST /api/ical-syncs/{id}/sync/`
4. Или используйте management команду:

```bash
# Синхронизировать все активные календари
python manage.py sync_ical

# Синхронизировать календари конкретного объекта
python manage.py sync_ical --listing-id 1

# Синхронизировать конкретную iCal синхронизацию
python manage.py sync_ical --ical-id 1
```

Рекомендуется настроить cron/celery для автоматической синхронизации.

### Поиск доступных объектов

```bash
# Через API поиска
POST /api/listings/search/
{
    "check_in": "2024-06-01",
    "check_out": "2024-06-10",
    "city": "Алматы",
    "max_price": 15000
}

# Или через query параметры
GET /api/listings/?check_in=2024-06-01&check_out=2024-06-10&city=Алматы
```

### Создание бронирования

```bash
POST /api/bookings/
{
    "listing_id": 1,
    "check_in": "2024-06-01",
    "check_out": "2024-06-10",
    "guests_count": 2
}
```

Если объект поддерживает мгновенное бронирование, бронирование будет подтверждено автоматически. Иначе оно будет ждать подтверждения владельца.

### Верификация объектов

Верификация объектов выполняется через админ-панель:
1. Перейдите в объект
2. Установите флаг "Проверено" (`is_verified`)
3. Статус модерации должен быть "Одобрено"

Верифицированные объекты:
- Поднимаются выше в поиске (сортировка по `is_verified`)
- Показываются как "Проверенные"
- Повышают доверие пользователей

## API Документация

Подробная документация по API находится в файле [API_USAGE.md](API_USAGE.md)

Основные endpoints:
- `/api/listings/` - Объекты жилья
- `/api/bookings/` - Бронирования
- `/api/reviews/` - Отзывы
- `/api/messages/` - Сообщения
- `/api/amenities/` - Удобства
- `/api/ical-syncs/` - Синхронизация iCal

## Структура проекта

```
listings/
├── models.py          # Модели данных
├── services.py        # Бизнес-логика (проверка доступности, синхронизация iCal)
├── serializers.py     # DRF сериализаторы
├── api_views.py       # API ViewSets
├── api_urls.py        # URL маршруты для API
├── admin.py           # Настройки админ-панели
└── management/
    └── commands/
        └── sync_ical.py  # Management команда для синхронизации iCal
```

## Модели данных

### Listing (Объект жилья)
Основная модель объекта с полями для верификации, ценообразования, правил и т.д.

### Booking (Бронирование)
Хранит информацию о бронированиях, статусы, оплату.

### Availability (Доступность)
Календарь доступности объекта по датам. Интегрируется с iCal.

### Review (Отзыв)
Верифицированные отзывы только от реальных гостей.

### Message (Сообщение)
Коммуникация между пользователями.

### ICalSync (Синхронизация iCal)
Настройки синхронизации с внешними календарями.

## Особенности реализации

### Защита от овербукинга

Система проверяет доступность объекта на несколько уровнях:
1. Проверка пересекающихся бронирований
2. Проверка календаря доступности (Availability)
3. Проверка минимальных/максимальных периодов

### Оптимизация поиска

QuerySet оптимизирован для быстрого поиска по доступности:
- Использует индексы на ключевых полях
- Исключает объекты с пересекающимися бронированиями одним запросом
- Фильтрует по календарю доступности

### Синхронизация iCal

Сервис парсит iCal календари и автоматически блокирует даты:
- Поддерживает стандартный формат iCalendar
- Хранит ссылку на внешний источник
- Позволяет настроить частоту синхронизации

## Дальнейшее развитие

Возможные улучшения:
- Интеграция с платежными системами
- Email/SMS уведомления
- Система рейтингов владельцев
- Мультиязычность
- Мобильное приложение
- Интеграция с картами (Google Maps, Yandex Maps)
- Система скидок и промокодов
- Статистика и аналитика для владельцев

## Лицензия

Этот проект создан для образовательных целей.


